{% extends "tasks/base.html" %}
{% block title %}{{ title }} ‚Äî TaskFlow{% endblock %}
{% block content %}

<div class="page-header">
    <h1 class="page-title">{{ title }}</h1>
</div>

<div class="form-page">
    <form method="post" class="form-card" id="projectForm">
        {% csrf_token %}
        <div class="form-group">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ *</label>
            {{ form.name }}
        </div>
        <div class="form-group">
            <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
            {{ form.description }}
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>–¶–≤–µ—Ç –ø—Ä–æ–µ–∫—Ç–∞</label>
                {{ form.color }}
            </div>
        </div>
        
        <div class="form-group">
            <label>–£—á–∞—Å—Ç–Ω–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞</label>
            <p class="form-help">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–¥ –ø—Ä–æ–µ–∫—Ç–æ–º</p>
            
            <!-- –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π select -->
            <div style="display: none;">
                {{ form.members }}
            </div>
            
            <!-- –ö—Ä–∞—Å–∏–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤—ã–±–æ—Ä–∞ -->
            <div class="members-selector">
                <div class="members-search">
                    <input type="text" id="memberSearch" class="form-input" placeholder="üîç –ü–æ–∏—Å–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...">
                </div>
                
                <div class="members-grid" id="membersGrid">
                    {% for user in form.fields.members.queryset %}
                    <div class="member-card" data-user-id="{{ user.id }}" data-user-name="{{ user.first_name }} {{ user.last_name }} {{ user.profile.position }}">
                        <div class="member-card-avatar" style="background: {{ user.profile.avatar_color }}">
                            {{ user.profile.initials }}
                        </div>
                        <div class="member-card-info">
                            <div class="member-card-name">{{ user.first_name }} {{ user.last_name }}</div>
                            <div class="member-card-position">{{ user.profile.position|default:"–°–æ—Ç—Ä—É–¥–Ω–∏–∫" }}</div>
                            {% if user.profile.department %}
                            <div class="member-card-dept">{{ user.profile.department }}</div>
                            {% endif %}
                        </div>
                        <div class="member-card-checkbox">
                            <input type="checkbox" name="members" value="{{ user.id }}" id="member_{{ user.id }}"
                                {% if user.id in form.initial.members %}checked{% endif %}>
                            <label for="member_{{ user.id }}" class="checkbox-custom"></label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        {% if form.errors %}
        <div class="form-errors">
            {% for field in form %}{% for error in field.errors %}<p>{{ field.label }}: {{ error }}</p>{% endfor %}{% endfor %}
        </div>
        {% endif %}
        
        <div class="form-actions">
            <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <a href="{% url 'project_list' %}" class="btn-ghost">–û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
// –ü–æ–∏—Å–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
document.getElementById('memberSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const cards = document.querySelectorAll('.member-card');
    
    cards.forEach(card => {
        const name = card.getAttribute('data-user-name').toLowerCase();
        if (name.includes(searchTerm)) {
            card.style.display = 'flex';
        } else {
            card.style.display = 'none';
        }
    });
});

// –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
document.querySelectorAll('.member-card input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const card = this.closest('.member-card');
        if (this.checked) {
            card.classList.add('selected');
        } else {
            card.classList.remove('selected');
        }
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    if (checkbox.checked) {
        checkbox.closest('.member-card').classList.add('selected');
    }
});

// –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —á–µ–∫–±–æ–∫—Å
document.querySelectorAll('.member-card').forEach(card => {
    card.addEventListener('click', function(e) {
        if (e.target.type !== 'checkbox' && !e.target.classList.contains('checkbox-custom')) {
            const checkbox = this.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            checkbox.dispatchEvent(new Event('change'));
        }
    });
});
</script>
{% endblock %}
